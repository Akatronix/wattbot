import { create } from "zustand";
import { persist, createJSONStorage } from "zustand/middleware";

export const useChatStore = create(
  persist(
    (set, get) => ({
      // State
      messages: [],
      isThinking: false,

      // Actions
      sendMessage: async (prompt, user, devices) => {
        // Add user message to the state immediately
        const userMessage = { from: "user", text: prompt };
        set((state) => ({
          messages: [...state.messages, userMessage],
          isThinking: true,
        }));

        try {
          // Call your Flask API
          const response = await fetch(
            "https://wattbot-ai.onrender.com/analyze",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                user_info: user,
                user_device_data: devices,
                user_prompt: prompt,
              }),
            }
          );

          if (!response.ok) {
            throw new Error(`API Error: ${response.statusText}`);
          }

          const data = await response.json();
          const aiMessage = { from: "ai", text: data.answer };

          // Add AI response to the state
          set((state) => ({
            messages: [...state.messages, aiMessage],
            isThinking: false,
          }));
        } catch (error) {
          console.error("Failed to send message:", error);
          const errorMessage = {
            from: "ai",
            text: "Sorry, I had trouble connecting. Please try again.",
          };
          set((state) => ({
            messages: [...state.messages, errorMessage],
            isThinking: false,
          }));
        }
      },

      // Optional: A function to clear the chat history
      clearChat: () => set({ messages: [] }),
    }),
    {
      name: "wattbot-chat-storage", // name of the item in localStorage
      storage: createJSONStorage(() => localStorage), // use localStorage
    }
  )
);
